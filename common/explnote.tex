\documentclass[explnote]{espd}
\usepackage[russian]{babel}
\usepackage{amsmath}

\bibliographystyle{gost2008}

\managerrank{Научный руководитель,\\доцент департамента\\программной инженерии\\факультета компьютерных наук,\\канд. техн. наук}
\manager{С.Л. Макаров}

\authorranki{студент группы БПИ183}
\authori{Д.А. Молдавский}

\authorrankii{студент группы БПИ183}
\authorii{М.И. Сердюков}

\title{Мессенджер с поиском по Bluetooth\\(серверная часть)}
\code{04.03}

\city{Москва}
\year{2021}

\begin{document}

\annotation
Пояснительная записка -- это документ, в котором описаны используемые алгоритмы, принципы функционирования и другая информация, касающаяся работы программы.

Настоящая Пояснительная записка содержит следующие разделы: <<Введение>>, <<Назначение и область применения>>, <<Технические характеристики>>, <<Ожидаемые технико-экономические показатели>>.

В разделе <<Введение>> указано наименование программы и приведены основания для разработки.

В разделе <<Назначение и область применения>> приведено назначение программы и описана характеристика области ее применения.

В разделе <<Технические характеристики>> указана постановка задачи на разработку, используемые в программе алгоритмы, принципы функционирования и методы организации входных и выходных данных.

В разделе <<Ожидаемые технико-экономические показатели>> указана предполагаемая потребность и преимущества разработки над аналогами.

Настоящая Пояснительная записка удовлетворяет требованиям ГОСТ 19.404-79~\cite{espd404}.

\tableofcontents

\section{Введение}
\subsection{Наименование программы}
\paragraph{Наименование программы на русском языке}
Мессенджер с поиском по Bluetooth.
\paragraph{Наименование программы на английском языке}
Messenger with Bluetooth Search.

\subsection{Условное обозначение разработки}
Условное обозначение разработки -- <<closecom>>.

\subsection{Основание для разработки}
Основанием для разработки является учебный план подготовки бакалавров по направлению 09.03.04 <<Программная инженерия>> и утвержденная академическим руководителем тема курсового проекта.

\section{Назначение и область применения}
\subsection{Область применения программы}
Программная система представляет собой мобильное приложение, и серверное приложение, работающие в связке по средствам REST Api~\cite{rest}.

Мобильное приложение решает задачу мессенджера - обладает функциями для авторизации пользователя, отправки и получения сообщений.

Серверное приложение применяется в контексте приложения для смартфонов (клиентского приложения). А так же, выполняет функции, которые требуют наличия сервера (хранение и отправка сообщений, данных пользователей, управление данными), что обосновывает необходимость данного приложения. Все необходимые функции работы выполняются с помощью HTTP запросов, которые передаются на вход веб-фреймворку и программе.

\subsection{Назначение разработки}
\paragraph{Функциональное назначение программы}
Данная разработка выполняет функции хранения данных о пользователях, чатах, сообщениях, Bluetooth идентификаторов, аутентификации пользователей, долгосрочного хранения этих данных, управлением чатами и сообщениями, а также отправки сообщений на почтовые ящики (для подтверждения различных действий пользователей).

\paragraph{Эксплуатационное назначение программы}
Программа предназначена для эксплуатации программистами или дежурными, которые занимаются поддержкой данного сервера в рамках развития проекта <<closecom>>.

\section{Требования к программе}
\subsection{Требования к функциональным характеристикам клиента}

Программа (мобильное приложение) должна обеспечивать следующий функционал:

\begin{enumerate}
\item Авторизация в приложении через электронную почту и пароль (создание аккаунта, регистрация);
\item Поиск пользователей в приложении по его идентификатору;
\item Возможность написать сообщение другому пользователю приложения (в виде текста и файлов);
\item Возможность просмотра истории сообщений с другим пользователем (чат с пользователем);
\item Возможность удаления чата с другим пользователем;
\item Начать переписку с другим пользователем "поблизости", используя Bluetooth;
\item Изменить электронную почту и пароль, привязанные к аккаунту;
\item Пользователь должен иметь возможность удалить собственный аккаунт.
\end{enumerate}

\paragraph{Требования к интерфейсу}

Мобильное приложение должно иметь следующую структуру интерфейса:

\begin{enumerate}
\item Экран авторизации;
\item Экран со списком всех доступных чатов;
\item Меню с настройками аккаунта и приложения;
\item Список всех сообщений с конкретным пользователем (экран чата);
\item Экран поиска пользователей по идентификатору;
\item Экран пользователей "поблизости", для поиска с использованием Bluetooth.
\end{enumerate}

\subsection{Требования к функциональным характеристикам сервера}
\paragraph{Требования к составу выполняемых функций}
Программа должна предоставлять следующие возможности, путем использования REST API:

\begin{enumerate}
\item Создание аккаунта с заданием почты и пароля;
\item Задание и изменение данных аккаунта;
\item Удаление аккаунта;
\item Получение списка текущих диалогов;
\item Получение сообщений указанного диалога;
\item Отправка сообщения указанному пользователю;
\item Удаление указанного сообщения или диалога;
\item Получение списка контактов, которые находятся рядом с пользователем.
\end{enumerate}

Также, серверная часть приложения должна обеспечивать следующий функционал поддержки:

\begin{enumerate}
\item Программа должна составлять логи для анализа ее работы;
\item Должна использоваться виртуализация для обеспечения надежности работы;
\item Исходный код должен быть расположен в git-репозитории;
\item Секретные данные (как данные для доступа к почтовому сервису) должны быть вынесены в отдельный файл секретов.
\end{enumerate}

\section{Технические характеристики}
\subsection{Постановка задачи на разработку программы}
Разрабатываемая программная система должна представлять собой связку из двух приложений. Где клиент решает задачу мессенджера и отображает данные получаемые с сервера. А серверное приложение обеспечивать работу приложения-клиента, поддерживая все необходимые для его работы обработчики HTTP запросов и соответствующий внутренний функционал. 

Подробное описание требований содержится в Техническом задании.

\subsection{Описание используеумых алгоритмов}
\paragraph{Механизм сканирования пользователей по bluetooth}
Поиск пользователей по близости осуществляется с использованием технологии bluetooth. После захода в приложение, bluetooth адрес пользователя сохраняется на удаленном сервере, при помощи POST запроса.

Затем, при сканировании, осуществляется bluetooth устройств по близости. Каждый адрес найденного устройства сравнивается с тем, который сохранил сервер на предыдущем шаге. Если совпадение было найдено, осуществляется получение данных этого пользователся (его имя и email).

\begin{verbatim}
override fun startScan() {
    scanner.startScan(object : ScanCallback() {
        override fun onScanResult(callbackType: Int, result: ScanResult) {

            val mac = result.device.address
            if (devices.find { it == mac } == null) {
                devices.add(mac)
                addDevicesToList(mac)
            }
        }
    })
}
\end{verbatim}

На листинге приведен пример кода, осуществляющего поиск адресов пользователей по близости, при помощи использования BluetoothLeScanner, класса из стандартной библиотеки Android. После того как пользователь был обнаружен, он будет добавлен в список найденных пользователей при помощи addDevicesToList(mac).

\paragraph{Обновление списка чатов и сообщений}
Для обеспеченья динамичности интерфейса, что бы данные менялись автоматическии, без взаимодействия пользователя, был использован паттерн Polling~\cite{polling}.

Для обновления спииска чатов REST Api~\cite{rest} клиент совершает запрос к серверу с интервалом 3 секунды.

\paragraph{Навигация в приложении}
Для обеспеченья навигации в приложении использовался подход Single Activity Application~\cite{SAA}. Он заключается в том, что на все приложение создается единственный тип Activity. Каждый экран представляет собой определенный тип Fragment. Activity сама определяет какой фрагмент должен быть показан в данный момент, в зависимости от ползьзовательских действий. 

Таким образом обеспечивается <<легковесность>> программы и высокая отзывчивость интерфейса.

\paragraph{Хранение пользовательских данных}
Для того, что бы обеспечить сохранение данных пользователя между сессиями использования приложения используется локальное хранилище SharedPreferences.

Таким образом, при перезаходе в приложение пользователю не приходится заново авторизироваться, это происходит автоматически. 

\paragraph{Обзор технологий}
Сервер написан на языке Python~\cite{python}. В качестве веб-фреймворка используется Flask~\cite{flask}, в качестве веб-сервера -- Gunicorn~\cite{gunicorn}. Для переадресации запросов используется Nginx~\cite{nginx}. Для хранения данных используется SQLite~\cite{sqlite}. ОС для хоста сервера -- Ubuntu 20.04 LTS minimal. Для виртуализации используется Python venv.

Все описанные выше инструменты и фреймворки выбраны исходя из ограниченного времени разработки и крайней ограниченности в технических средствах. При этом масштабируемость решения в данных условиях не являлась приоритетной задачей.

\paragraph{Устройство сервера}
\subparagraph{Директория runtime}
В папке runtime расположено виртуальное окружение Python, репозиторий и командные файлы для совершения типовых операций с сервером.

Виртуальное окружение предназначено для изоляции зависимостей сервера от пользовательских настроек и библиотек. Это позволяет на этом же физическом сервере производить различные операции в Python не затрагивая непосредственно работающую программу. Данное решение изоляции более предпочтительное, чем использование инструментов виртуализации (Docker, виртуальные машины), так как программа разрабатывается в условиях использования очень ограниченных технических ресурсов.

Репозиторий -- собственно, исполняемый код программы. Является локальной копией удаленного репозитория, что позволяет упростить выпуск новых версий. Таким образом, для выпуска новой версии сервера достаточно обновить удаленный сервер и загрузить ее с помощью встроенных в git инструментов.

Командные файлы -- набор исполняемых файлов bash, которые содержат типовые операции управления веб-сервером gunicorn. Они позволяют быстро запустить, остановить и обновить сервер .

\subparagraph{Директория logs}
В папке logs содержатся логи, которые непрерывно пишутся сервером. Они предзназначены для анализа деятельности сервера, в том числе ошибок. Более детальное их описание содержится в пункте \label{paragraph:output}.

\subparagraph{Директория data}
В папке data содержатся данные сервера, отделенные от репозитория для обеспечения безопасности этих данных (независимости от удаленного репозитория), а также для их сохранности между обновлениями сервера. Здесь используется файл database.db (файл SQLite базы данных) и secrets.json.

secrets.json -- это файл секретов. Секреты -- это данные, которые технически относятся к серверу и не меняются, но не включаются в часть репозитория, так как они должны быть от него изолированы (по причине безопасности). Тут хранятся данные для доступа к почтовому ящику, от которого отправляются e-mail сообщения, а также адрес сервера (который не зависит от кода, но зависит от используемого физического сервера).

\subparagraph{Файл runtime.pid}
Файл runtime.pid содержит id мастер-процесса сервера. Используется для удобного завершения работы программы.

\paragraph{Миграции}
Для организации базы данных используется подход миграций. Это значит, что новые изменения в таблице записываются в новый файл в директории migrations, после чего они выполняются из-под виртуального Python окружения инструментом run\_migration. Данный подход позволяет обновлять сервер, не обнуляя данные (и, как следствие, пропадает необходимость в организации специальных транспортов этих данных).

При разработке был использован единственный файл миграций -- v01\_init.sql, но после запуска сервера для использования пользователями необходимо будет новые изменения оформлять в виде новых миграций.

\paragraph{Используемые решения мессенджера}
Для выполнения функционала мессенджера реализован минимальный набор обработчиков:

\begin{enumerate}
\item /chats -- получить список активных чатов;
\item /chat\_history -- получить информацию о конкретном чате;
\item /start\_dialog -- инициировать чат с пользователем по e-mail, вернуть id;
\item /user\_search -- поиск пользователей по e-mail;
\item /create\_chat -- инициировать чат с известными id пользователей;
\item /send\_message -- отправить сообщение;
\end{enumerate}

Полный список реализованных обработчиков сервера в приложении.

Необходимо заметить, что для идентификации всех объектов сервера используются id, в том числе для сообщений и чатов. Таким образом, при выполнении операций с ними они должны быть переданы от клиента.

\paragraph{Аутентификация пользователей}
Концепция мессенджера предполагает контроль доступа пользователей. Для контроля доступа используются токены - случайные строки фиксированной длины, которые генерируются сервером и передаются пользователю, которые являются его идентификатором для всех запросов.

Для регистрации новых пользователей используется почтовый ящик и пароль. Ввода этих данных достаточно для получения токена доступа (и, соответственно, выполнения всех доступных на сервере действий). Однако для каждого зарегистрированного пользователя хранится поле подтверждения, для включения которого пользователь должен подтвердить владение введенным почтовым ящиком.

Для этого при регистрации сервер отправляет ссылку на подтверждение аккаунта, в которой включен токен. При клике этой ссылки происходит подтверждение.

В случае, если пользователь хочет восстановить пароль, он должен отправить соответствующий запрос. После этого на почтовый ящик отправляется ссылка на форму ввода пароля с токеном изменения пароля. При клике токен пробрасывается через сервер обратно пользователю, но уже как часть формы. При изменении пароля этот токен снова передается на сервер, но уже с новым паролем. Таким образом возможна авторизованная смена пароля.

Авторизация происходит с помощью токена доступа. Для его получения на сервер отправляется e-mail и пароль, пользователю при этом возвращается токен.

Для сохранности паролей сразу при получении их сервером они хэшируются, таким образом, при утечке базы данных пароли пользователей не будут таким образом утеряны.

\subsection{Описание и обоснование выбора метода организации входных и выходных данных}
\paragraph{Организация входных данных}
Выходные данные для программы -- это внешние HTTP запросы, которые приложение-клиент посылает на сервер, который, в свою очередь, переадресует их непосредственно обработчику запросов веб-сервера с помощью nginx. Вид запросов согласуется с разработкой мобильного приложения.

\paragraph{Организация выходных данных}\label{paragraph:output}
Выходные данные программы:

\begin{enumerate}
\item HTTP-ответы сервера;
\item логи.
\end{enumerate}

Ответы сервера согласуются с мобильным приложением в рамках интеграции (как и входные данные).

Логи пишутся в директорию logs сервера, они бывают двух видов:

\begin{enumerate}
\item Access-логи;
\item Error-логи.
\end{enumerate}

В текущей конфигурации access-логи пишутся в файл logs/access.log дублируют логи доступа nginx и сохраняют информацию о запросах (время, их URL) и ответ сервера (код). Может быть использован для оценки нагрузки и изучении характеристики использования сервера сторонними ресурсами.

Error-логи пишутся в файл logs/error.log и содержат вывод непосредственно программы при работе. Здесь нужно различать INFO-вывод программы (данные при обработке запросов) и INFO-вывод веб-сервера (служебная информация, запуск/остановка и ошибки).

Более подробное описание логов содержится в Руководстве программиста.

\subsection{Описание и обоснование выбора состава технических средств}
Для обеспечения функционирования программы необходим сервер со следующими характеристиками:

\begin{enumerate}
\item 1 ядро CPU;
\item 0.6 ГБ RAM;
\item 10 Гб дискового пространства;
\item Доступ в интернет.
\end{enumerate}

Такие требования обусловлены минимальными характеристиками сервера, на котором производились разработка и тестирование программы.

\subsection{Описание и обоснование выбора программных средств}
Для работы программы используется Ubuntu 20.04 LTS minimal. Такой выбор объясняется бесплатностью, высокой надежностью и малой потребностью в тезнических средствах данной системы.

\section{Ожидаемые технико-экономические показатели}
\subsection{Предполагаемая потребность}
Зачем будет юзаться прога

\subsection{Экономические преимущества разработки по сравнению с аналогами}
Чем мы лучше аналогов

\bibliography{espd,library}

\begin{terms}
\term{Логи}{данные, которые сервер пишет локально при запросах. Служат для отладки и анализа работы сервера}
\term{Приложение-клиент (мобильное приложение)}{приложение, с которого запросы поступают на сервер}
\term{Переадресация (проксирование) запросов}{переадресация HTTP запросов, которая выполняется nginx. Служит для контроля конечных точек запросов}
\term{Мессенджер}{приложение, предназначенное для обмена сообщениями между пользователями}
\end{terms}

\attachment{Справочное}{Обработчики сервера}

\begin{center}
\begin{tabular}{| l | l |}
\hline
POST /account/create & Регистрация пользователя с получением токена \\ \hline
GET /account/confirm & Подтверждение аккаунта пользователем \\ \hline
POST /account/recovery & Запрос отправки сообщения с подтверждением пароля \\ \hline
GET /account/recovery\_form & Запрос формы изменения пароля \\ \hline
POST /account/change\_password & Изменение пароля (вызывается только из формы) \\ \hline
POST /account/auth & Авторизация пользователя с получением токена \\ \hline
POST /account/delete & Удаление аккаунта \\ \hline
POST /account/set\_about & Обновление данных о пользователе \\ \hline
GET /bluetooth/user\_about & Получение данных о пользователе по Bluetooth ID \\ \hline
POST /bluetooth/set\_bid & Установление Bluetooth ID \\ \hline
GET /messenger/chats & Получение список чатов \\ \hline
GET /messenger/chat\_history & Получение истории конкретного чата \\ \hline
POST /messenger/start\_dialog & Инициирование диалога с пользователем \\ \hline
GET /messenger/user\_search & Поиск пользователей по подстроке e-mail \\ \hline
POST /messenger/create\_chat & Создание чата с пользователями с известным id \\ \hline
POST /messenger/send\_message & Отправка сообщения в чат \\ \hline
POST /messenger/delete\_message & Удаление сообщения \\ \hline
POST /messenger/delete\_chat & Удаление чата \\ \hline
\end{tabular}
\end{center}

\end{document}
